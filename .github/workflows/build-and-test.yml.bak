name: Build

on:
    push:
        branches:
            - master
        tags:
            - "v*"
    pull_request:
        branches:
            - master

jobs:
    Coverage:
        runs-on: windows-latest
        needs: [Build]
        steps:
            - uses: actions/checkout@v1

            - name: Install nuget
              uses: NuGet/setup-nuget@v1

            - name: Enable long file paths
              run: git config --global core.longpaths true

            - name: Update submodules
              run: git submodule -q update --init --recursive

            - name: Generate Test Coverage
              shell: pwsh
              run: ./tests/CodeCoverage/CodeCoverage.ps1
              env:
                  CI: True

            - name: Update codecov
              uses: iansu/codecov-action-node@v1.0.0
              with:
                  token: ${{secrets.CODECOV_TOKEN}}
                  file: "ImageSharp.Coverage.xml"
                  flags: unittests

    Build:
        strategy:
            matrix:
                opts:
                    - os: ubuntu-latest
                      framework: netcoreapp2.1
                      is32Bit: False
                      doCoverage: False
                    - os: windows-latest
                      framework: netcoreapp2.1
                      is32Bit: False
                      doCoverage: True
                    - os: windows-latest
                      framework: net472
                      is32Bit: False
                      doCoverage: False
                    - os: windows-latest
                      framework: net472
                      is32Bit: True
                      doCoverage: False

        runs-on: ${{ matrix.opts.os }}

        steps:
            - uses: actions/checkout@v1

            - name: install nuget
              uses: NuGet/setup-nuget@v1

            - name: Enable long file paths
              run: |
                  git config --global core.autocrlf false
                  git config --global core.longpaths true

            - name: Update submodules
              run: git submodule -q update --init

            - name: Build
              shell: pwsh
              run: |
                  $DebugPreference = "Continue"
                  ./build.ps1 "${{matrix.opts.framework}}"

            - name: Test
              shell: pwsh
              run: ./run-tests.ps1 "${{ matrix.opts.os }}" "${{matrix.opts.framework}}" "${{matrix.opts.is32Bit}}" "${{matrix.opts.doCoverage}}"
              env:
                  CI: True

    Publish:
        runs-on: windows-latest
        needs: [Build]
        if: github.event_name == 'push'
        steps:
            - uses: actions/checkout@v1

            - name: install nuget
              uses: NuGet/setup-nuget@v1

            - name: Enable long file paths
              run: git config --global core.longpaths true

            - name: Update submodules
              run: git submodule -q update --init --recursive

            - name: Build
              shell: pwsh
              run: |
                  $DebugPreference = "Continue"
                  ./build.ps1

            - name: Publish to nightly feed -myget
              if: success()
              run: nuget.exe push .\artifacts\*.nupkg ${{secrets.MYGET_TOKEN}} -Source https://www.myget.org/F/sixlabors/api/v2/package
        # TODO: if github.ref starts with 'refs/tags' then it was tag push and we can optionally push out package to nuget.org
